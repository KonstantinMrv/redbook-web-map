<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <title>RedBook Web Map — Animals & Plants/Fungi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body {height:100%;margin:0;font-family:Arial, sans-serif;}
    #map {position:absolute;inset:0;}
    #sidebar {
      position:absolute;top:10px;right:10px;width:420px;max-width:95vw;
      max-height:calc(100% - 20px);overflow:auto;background:#fff;
      padding:12px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:9999;
    }
    #list {height:50vh;overflow:auto;border-top:1px solid #ddd;margin-top:6px;}
    .feature-item {padding:8px;border-bottom:1px solid #eee;cursor:pointer;}
    .feature-item:hover {background:#faf6e8;}
    .feature-row {display:grid;grid-template-columns:1fr 120px;align-items:center;gap:8px;}
    .link-btn {
      width:120px;text-align:center;padding:6px 8px;font-size:12px;
      border-radius:6px;border:1px solid #ccc;background:#f4f6ff;cursor:pointer;white-space:nowrap;
    }
    .link-btn:hover {background:#e9edff;}
    .link-btn:disabled {opacity:.5;cursor:not-allowed;}
    .pt-marker {background:#1f78b4;width:8px;height:8px;border-radius:50%;border:1px solid white;}
    .pt-marker.highlight {background:#ff7f0e;}
    .poly-label {background:rgba(255,255,255,.75);padding:2px 6px;border-radius:8px;border:1px solid #ccc;font-size:12px;}
    .leaflet-interactive.hovered {stroke-width:3px!important;filter:brightness(1.2);}
  </style>
</head>
<body>
<div id="map"></div>
<div id="sidebar">
  <h3>Червена книга</h3>
  <section>
    <label><input type="radio" name="poly" value="morph" checked> morph_units</label>
    <label><input type="radio" name="poly" value="land"> landscape_zoning</label>
  </section>
  <section>
    <label><input type="radio" name="points" value="animals" checked> Animals</label>
    <label><input type="radio" name="points" value="plants"> PlantsFungi</label>
  </section>
  <input id="searchBox" type="text" placeholder="Търси…" />
  <button id="btnClearSel">Изчисти селекцията</button>
  <div id="count"></div>
  <div id="list"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script>
const urls = {
  morph:'data/morph_units.geojson',
  land:'data/landscape_zoning.geojson',
  animals:'data/Animals.geojson',
  plants:'data/PlantsFungi.geojson'
};
const map = L.map('map').setView([42.75,25.3],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20}).addTo(map);

const state = {
  activePoly:'morph',
  activePts:'animals',
  selectedPolygonFeature:null,
  selectedPolygonLayer:null,
  explodedPoints:[],
  pointMarkerLayer:L.layerGroup().addTo(map),
  currentMarkers:[],
  currentMarkersByKey:new Map()
};

function explodeMultiPoints(fc){
  const out=[];
  fc.features.forEach(f=>{
    if(f.geometry.type==='MultiPoint'){
      f.geometry.coordinates.forEach(c=>out.push({type:'Feature',geometry:{type:'Point',coordinates:c},properties:{...f.properties}}));
    }else if(f.geometry.type==='Point'){out.push(f);}
  });
  return out;
}

function speciesKey(p){return (p.LATIN_NAME||'')+'||'+(p.BG_NAME||'');}

function getFeatureLink(p){
  const cand=p.ARTICLE_URL||p.LINK||p.URL;
  if(!cand)return null;
  let href=String(cand).trim();
  if(!/^https?:\/\//i.test(href)) href='https://'+href;
  return href;
}

Promise.all([
  fetch(urls.morph).then(r=>r.json()),
  fetch(urls.land).then(r=>r.json()),
  fetch(urls.animals).then(r=>r.json()),
  fetch(urls.plants).then(r=>r.json())
]).then(([morph,land,animals,plants])=>{
  state.polyLayers={
    morph:L.geoJSON(morph,{style:{color:'#B08D57',weight:1,fillColor:'#F3E5AB',fillOpacity:0.65},
      onEachFeature:(f,l)=>{
        l.on({
          mouseover:e=>{if(e.target._path)e.target._path.classList.add('hovered');},
          mouseout:e=>{if(e.target._path)e.target._path.classList.remove('hovered');},
          click:()=>onPolygonClick(f,l)
        });
        if(f.properties.NAME) l.bindTooltip(f.properties.NAME,{permanent:true,direction:'center',className:'poly-label'});
      }}).addTo(map),
    land:L.geoJSON(land,{style:{color:'#5A8F68',weight:1,fillColor:'#CDE8B8',fillOpacity:0.65},
      onEachFeature:(f,l)=>{
        l.on({
          mouseover:e=>{if(e.target._path)e.target._path.classList.add('hovered');},
          mouseout:e=>{if(e.target._path)e.target._path.classList.remove('hovered');},
          click:()=>onPolygonClick(f,l)
        });
        if(f.properties.NAME) l.bindTooltip(f.properties.NAME,{permanent:true,direction:'center',className:'poly-label'});
      }})
  };
  state.data={animals,plants};
  state.explodedPoints=explodeMultiPoints(state.data[state.activePts]);
});

function onPolygonClick(f,l){
  if(state.selectedPolygonLayer) state.selectedPolygonLayer.setStyle(state.activePoly==='morph'?{color:'#B08D57',weight:1,fillColor:'#F3E5AB',fillOpacity:0.65}:{color:'#5A8F68',weight:1,fillColor:'#CDE8B8',fillOpacity:0.65});
  state.selectedPolygonFeature=f;
  state.selectedPolygonLayer=l;
  l.setStyle(state.activePoly==='morph'?{color:'#B08D57',weight:4,fillColor:'#FFF4C9',fillOpacity:0.8}:{color:'#5A8F68',weight:4,fillColor:'#E9F6D8',fillOpacity:0.8});
  const exploded=explodeMultiPoints(state.data[state.activePts]);
  const inside=exploded.filter(pt=>turf.booleanPointInPolygon(pt,f));
  state.explodedPoints=inside;
  renderList(inside);
}

document.querySelectorAll('input[name="poly"]').forEach(r=>r.addEventListener('change',()=>{
  map.removeLayer(state.polyLayers[state.activePoly]);
  if(state.selectedPolygonLayer) state.selectedPolygonLayer=null;
  state.activePoly=r.value;
  map.addLayer(state.polyLayers[state.activePoly]);
  clearSelection();
}));
document.querySelectorAll('input[name="points"]').forEach(r=>r.addEventListener('change',()=>{
  state.activePts=r.value;
  state.explodedPoints=explodeMultiPoints(state.data[state.activePts]);
  renderList(state.explodedPoints);
}));
document.getElementById('btnClearSel').onclick=clearSelection;
document.getElementById('searchBox').oninput=()=>renderList(state.explodedPoints);

function clearSelection(){
  if(state.selectedPolygonLayer){
    state.selectedPolygonLayer.setStyle(state.activePoly==='morph'?{color:'#B08D57',weight:1,fillColor:'#F3E5AB',fillOpacity:0.65}:{color:'#5A8F68',weight:1,fillColor:'#CDE8B8',fillOpacity:0.65});
  }
  state.selectedPolygonLayer=null;
  state.selectedPolygonFeature=null;
  state.explodedPoints=explodeMultiPoints(state.data[state.activePts]);
  renderList(state.explodedPoints);
}

function renderList(features){
  const search=document.getElementById('searchBox').value.toLowerCase();
  const list=document.getElementById('list');
  list.innerHTML='';
  state.pointMarkerLayer.clearLayers();
  state.currentMarkers=[];
  state.currentMarkersByKey=new Map();
  const filtered=features.filter(f=>{
    const p=f.properties||{};
    return !search|| (p.BG_NAME||'').toLowerCase().includes(search)||(p.LATIN_NAME||'').toLowerCase().includes(search);
  });
  filtered.forEach(f=>{
    const [lng,lat]=f.geometry.coordinates;
    const key=speciesKey(f.properties);
    const m=L.marker([lat,lng],{icon:L.divIcon({className:'pt-marker',iconSize:[10,10]})})
      .addTo(state.pointMarkerLayer)
      .on('click',()=>openPopup([lat,lng],f.properties));
    m._speciesKey=key;
    state.currentMarkers.push(m);
    if(!state.currentMarkersByKey.has(key))state.currentMarkersByKey.set(key,[]);
    state.currentMarkersByKey.get(key).push(m);
  });
  const unique=[];
  state.currentMarkersByKey.forEach((markers,key)=>{
    const rep=filtered.find(ft=>speciesKey(ft.properties)===key)||{};
    unique.push({key,count:markers.length,props:rep.properties||{}});
  });
  unique.forEach(item=>{
    const p=item.props;
    const div=document.createElement('div');
    div.className='feature-item';
    const top=document.createElement('div');
    top.className='feature-row';
    const title=document.createElement('div');
    title.textContent=(p.BG_NAME||'')+(p.LATIN_NAME?` (${p.LATIN_NAME})`:'');
    const btn=document.createElement('button');
    btn.className='link-btn';
    const link=getFeatureLink(p);
    btn.textContent='Отвори статия';
    btn.disabled=!link;
    if(link)btn.onclick=e=>{e.stopPropagation();window.open(link,'_blank');};
    top.appendChild(title);top.appendChild(btn);
    div.appendChild(top);
    div.onclick=()=>{
      state.currentMarkers.forEach(mk=>mk._icon.classList.remove('highlight'));
      const group=state.currentMarkersByKey.get(item.key)||[];
      const latlngs=[];
      group.forEach(mk=>{mk._icon.classList.add('highlight');latlngs.push(mk.getLatLng());});
      if(latlngs.length===1){
        map.setView(latlngs[0],Math.max(10,Math.min(11,map.getZoom())),{animate:true});
      }else if(latlngs.length>1){
        map.fitBounds(L.latLngBounds(latlngs).pad(0.25),{maxZoom:12});
      }
    };
    list.appendChild(div);
  });
  document.getElementById('count').textContent=`Намерени видове: ${unique.length} (точки: ${filtered.length})`;
}

function openPopup(latlng,props){
  const rows=Object.keys(props).map(k=>`<tr><th>${k}</th><td>${props[k]}</td></tr>`);
  L.popup().setLatLng(latlng).setContent(`<table>${rows.join('')}</table>`).openOn(map);
}
</script>
</body>
</html>
